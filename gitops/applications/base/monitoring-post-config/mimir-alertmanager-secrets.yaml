apiVersion: redhatcop.redhat.io/v1alpha1
kind: RandomSecret
metadata:
  name: alertmanager-slack-alert-notifications
  namespace: ${ARGOCD_ENV_vault_namespace}
spec:
  authentication:
    path: ${ARGOCD_ENV_vault_k8s_admin_auth_path}
    role: ${ARGOCD_ENV_vault_k8s_admin_role_name}
    serviceAccount:
      name: default
  isKVSecretsEngineV2: true
  path: /secret/data/mimir/
  secretKey: webhook
  secretFormat:
    passwordPolicyName: grafana-password-policy
  # refreshPeriod: 0h # Keep it commented. We do not want the secret to be rotated by vault-config-operator
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: alertmanager-slack-alert-notifications
spec:
  refreshInterval: 1m

  secretStoreRef:
    kind: ClusterSecretStore
    name: vault-secret-store

  data:
    - secretKey: webhook
      remoteRef:
        key: mimir/alertmanager-slack-alert-notifications
        property: webhook

  target:
    name: alertmanager-slack-alert-notifications
    creationPolicy: Owner
    template:
      data:
        config.yaml: |
          route:
            # Main alert routing configuration
            receiver: 'slack'
            group_by: ['job']
            # group_by: ['...']
            group_wait: 30s
            group_interval: 5m
            repeat_interval: 24h
          receivers:
            # Default receiver for all alerts
            - name: 'slack'
              slack_configs:
                - api_url: {{.webhook}}
                  send_resolved: true
---
