---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: zitadel-db-credentials
  namespace: ${ARGOCD_ENV_zitadel_namespace}
spec:
  refreshInterval: 1m

  secretStoreRef:
    kind: SecretStore
    name: zitadel-secret-store

  data:
    - secretKey: user
      remoteRef:
        key: ${ARGOCD_ENV_zitadel_db_secret_name}
        property: user
    - secretKey: dbname
      remoteRef:
        key: ${ARGOCD_ENV_zitadel_db_secret_name}
        property: dbname
    - secretKey: host
      remoteRef:
        key: ${ARGOCD_ENV_zitadel_db_secret_name}
        property: pgbouncer-host
    - secretKey: password
      remoteRef:
        key: ${ARGOCD_ENV_zitadel_db_secret_name}
        property: password
    - secretKey: port
      remoteRef:
        key: ${ARGOCD_ENV_zitadel_db_secret_name}
        property: port

  target:
    name: ${ARGOCD_ENV_zitadel_config_secret_name}
    creationPolicy: Owner
    template:
      data:
        config.yaml: |
          Database:
            Postgres:
              Host: {{.host}}
              User:
                Password: '{{.password}}'
              Admin:
                Password: '{{.password}}'
