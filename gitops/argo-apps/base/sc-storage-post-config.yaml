apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: ${ARGOCD_ENV_utils_capi_capi_rook_ceph_post_config_app_name}
  namespace: ${ARGOCD_ENV_argocd_app_namespace}
  annotations:
    argocd.argoproj.io/sync-wave: ${ARGOCD_ENV_utils_capi_capi_rook_ceph_post_config_sync_wave}

  finalizers:
    - resources-finalizer.argocd.argoproj.io

spec:
  project: default
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    retry:
      limit: 20
      backoff:
        duration: 10s
        maxDuration: 3m0s
        factor: 2
    syncOptions:
      - CreateNamespace=true
      - PrunePropagationPolicy=foreground
      - PruneLast=true
  destination:
    server: "https://kubernetes.default.svc"
    namespace: ${ARGOCD_ENV_utils_capi_capi_rook_ceph_namespace}

  info:
    - name: ceph-health
      resources:
        - group: ceph.rook.io
          kind: CephCluster
          name: rook-ceph
          namespace: rook-ceph
          jsonPointers:
            - /status/ceph/health
            - /status/phase
  source:
    repoURL: ${ARGOCD_ENV_argocd_repo_url}
    targetRevision: ${ARGOCD_ENV_utils_application_gitrepo_tag}
    path: gitops/applications/base/sc-storage-post-config
    resource:
      - group: batch
        version: v1
        kind: Job
        name: check-rook-ceph-health
        namespace: rook-ceph
        hook: PreSync
        hookDeletePolicy: HookSucceeded
        manifest: |
          apiVersion: batch/v1
          kind: Job
          metadata:
            name: check-rook-ceph-health
            namespace: rook-ceph
          spec:
            template:
              spec:
                containers:
                - name: check-health
                  image: rook/ceph:latest
                  command:
                  - /bin/sh
                  - -c
                  - |
                    until ceph status | grep -q 'HEALTH_OK'; do
                      echo "Waiting for Ceph cluster to be healthy..."
                      sleep 10
                    done
                restartPolicy: OnFailure
            backoffLimit: 10
    plugin:
      name: envsubst
      env:
        - name: "storage_namespace"
          value: "${ARGOCD_ENV_utils_capi_capi_rook_ceph_namespace}"

        - name: "rook_ceph_image_version"
          value: "${ARGOCD_ENV_utils_capi_capi_rook_ceph_image_version}"

        - name: "storage_rgw_subdomain"
          value: "${ARGOCD_ENV_utils_capi_capi_rook_ceph_rgw_subdomain}"
